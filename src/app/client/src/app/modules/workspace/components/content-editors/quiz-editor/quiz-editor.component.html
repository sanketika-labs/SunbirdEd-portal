<div class="quiz-editor" *ngIf="!isLoading">
    <!-- Blue Header -->
    <div class="sb-bg-color-primary">
        <div class="ui container py-15">
            <div class="d-flex flex-ai-center sb-color-white">
                <button class="back-button sb-btn sb-btn-primary sb-btn-xs back-btn px-0 hover-none fs-0-92 font-weight-bold"
                    (click)="goBack()" aria-label="back">
                    <i class="arrow left icon" aria-hidden="true"></i> {{resourceService?.frmelmnts?.btn?.back}}
                </button>
            </div>
        </div>
    </div>

    <!-- Content Header -->
    <div class="sb-bg-lightBlue bb-1">
        <div class="d-flex flex-jc-space-between flex-ai-center py-20 ui container">
            <div>
                <div class="practical-header__title font-weight-bold pl-20 fs-0-92" tabindex="0">
                    {{ quizName || 'Untitled' }}
                </div>
            </div>
            <div class="d-flex flex-ai-center">
                <button class="sb-btn sb-btn-normal sb-btn-outline-primary mr-10" (click)="previewQuiz()">
                    <i class="icon eye" aria-hidden="true"></i>
                    Preview
                </button>
                <button class="sb-btn sb-btn-normal sb-btn-outline-primary mr-10" 
                        [disabled]="!canSaveAsDraft"
                        [ngClass]="{'sb-disabled': !canSaveAsDraft}"
                        (click)="saveDraft()">
                    <i class="icon save" aria-hidden="true"></i>
                    Save as Draft
                </button>
                <button class="sb-btn sb-btn-normal sb-btn-primary mr-10" (click)="publishQuiz()">
                    Send for Review
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content Area with Form Layout -->
    <div class="h-100vh sb-bg-white">
        <div class="ui">
            <div class="ui twelve column grid m-0">
                <!-- Right Form Panel (similar to meta-form) -->
                <div class="twelve wide column bg-white mb-10 w-73">
                    <!-- Meta Form for Quiz Details - Always Visible -->
                    <div class="quiz-meta-form p-200">       
                        <!-- Angular Material Form -->
                        <form class="quiz-form quiz-form-styled">
                            <!-- Title and Type in same row (50% each) -->
                            <div class="form-row-flex">
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.title || 'Title'}}</mat-label>
                                    <input matInput 
                                           [formControl]="titleFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterTitle || 'Enter title'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="titleFormControl.hasError('required') && (titleFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.titleIsRequired || 'Title is required'}}</mat-error>
                                    <mat-error *ngIf="titleFormControl.hasError('leadingTrailingSpaces') && !titleFormControl.hasError('required') && (titleFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.noLeadingTrailingSpaces || 'Title cannot have leading or trailing spaces'}}</mat-error>
                                </mat-form-field>
                                
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.type || 'Type'}}</mat-label>
                                    <mat-select [formControl]="typeFormControl" 
                                               class="times-new-roman-font">
                                        <mat-option value="section">{{'SECTION'}}</mat-option>
                                        <mat-option value="module">{{'MODULE'}}</mat-option>
                                        <mat-option value="course">{{'COURSE'}}</mat-option>
                                        <mat-option value="level">{{'LEVEL'}}</mat-option>
                                        <mat-option value="framework">{{'FRAMEWORK'}}</mat-option>
                                    </mat-select>
                                    <mat-error *ngIf="typeFormControl.hasError('required') && (typeFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.typeIsRequired || 'Type is required'}}</mat-error>
                                </mat-form-field>
                            </div>
                            
                            <!-- Attempts and No of questions in same line (50% each) -->
                            <div class="form-row-flex">
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.attempts || 'Attempts'}}</mat-label>
                                    <input matInput 
                                           type="number"
                                           [formControl]="attemptsFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterAttempts || 'Enter number of attempts'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="attemptsFormControl.hasError('required') && (attemptsFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.attemptsRequired || 'Attempts is required'}}</mat-error>
                                    <mat-error *ngIf="attemptsFormControl.hasError('min') && !attemptsFormControl.hasError('required') && (attemptsFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.attemptsMin || 'Must be at least 1'}}</mat-error>
                                </mat-form-field>
                                
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.numberOfQuestions || 'No of questions'}}</mat-label>
                                    <input matInput 
                                           type="number"
                                           [formControl]="numberOfQuestionsFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterNumberOfQuestions || 'Enter number of questions'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="numberOfQuestionsFormControl.hasError('required') && (numberOfQuestionsFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.numberOfQuestionsRequired || 'Number of questions is required'}}</mat-error>
                                    <mat-error *ngIf="numberOfQuestionsFormControl.hasError('min') && !numberOfQuestionsFormControl.hasError('required') && (numberOfQuestionsFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.numberOfQuestionsMin || 'Must have at least 1 question'}}</mat-error>
                                </mat-form-field>
                            </div>
                            <!-- Divider Line -->
                            <hr class="form-divider">

                            <!-- Difficulty Section Title -->
                            <div class="section-title-container">
                                <h3 class="section-title">
                                    {{resourceService?.frmelmnts?.lbl?.difficulty || 'Difficulty'}}
                                </h3>
                            </div>
                            
                            <!-- Easy, Medium, Hard inputs in one line (similar to skill map's 3-column layout) -->
                            <div class="form-row-flex">
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.easy || 'Easy'}}</mat-label>
                                    <input matInput 
                                           type="number"
                                           [formControl]="easyFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterEasy || 'Enter easy questions count'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="easyFormControl.hasError('required') && (easyFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.easyRequired || 'Easy questions count is required'}}</mat-error>
                                    <mat-error *ngIf="easyFormControl.hasError('min') && !easyFormControl.hasError('required') && (easyFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.easyMin || 'Must be 0 or greater'}}</mat-error>
                                </mat-form-field>
                                
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{'Medium'}}</mat-label>
                                    <input matInput 
                                           type="number"
                                           [formControl]="mediumFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterMedium || 'Enter medium questions count'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="mediumFormControl.hasError('required') && (mediumFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.mediumRequired || 'Medium questions count is required'}}</mat-error>
                                    <mat-error *ngIf="mediumFormControl.hasError('min') && !mediumFormControl.hasError('required') && (mediumFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.mediumMin || 'Must be 0 or greater'}}</mat-error>
                                </mat-form-field>
                                
                                <mat-form-field appearance="outline" class="form-field-flex">
                                    <mat-label class="form-label-black">{{resourceService?.frmelmnts?.lbl?.hard || 'Hard'}}</mat-label>
                                    <input matInput 
                                           type="number"
                                           [formControl]="hardFormControl"
                                           placeholder="{{resourceService?.frmelmnts?.lbl?.enterHard || 'Enter hard questions count'}}"
                                           class="times-new-roman-font">
                                    <mat-error *ngIf="hardFormControl.hasError('required') && (hardFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.hardRequired || 'Hard questions count is required'}}</mat-error>
                                    <mat-error *ngIf="hardFormControl.hasError('min') && !hardFormControl.hasError('required') && (hardFormControl.touched || showValidationErrors)">{{resourceService?.frmelmnts?.lbl?.hardMin || 'Must be 0 or greater'}}</mat-error>
                                </mat-form-field>
                            </div>

                            <!-- Question Distribution Summary -->
                            <div class="question-distribution-summary">
                                <div class="distribution-header">
                                    <span class="distribution-label">
                                        {{resourceService?.frmelmnts?.lbl?.questionDistribution || 'Question Distribution'}}:
                                    </span>
                                    <span class="distribution-count" 
                                          [ngStyle]="{
                                            'color': getCurrentQuestionTotal() === getTotalQuestions() ? '#4caf50' : '#f44336'
                                          }">
                                        {{getCurrentQuestionTotal()}} / {{getTotalQuestions()}}
                                    </span>
                                </div>
                                <div *ngIf="getCurrentQuestionTotal() !== getTotalQuestions()" 
                                     class="distribution-error">
                                    {{resourceService?.frmelmnts?.lbl?.distributionMismatch || 'The sum of difficulty levels must equal the total number of questions'}}
                                </div>
                            </div>

                            <!-- Divider Line -->
                            <hr class="form-divider">

                            <!-- Observable Elements Section -->
                            <div class="observable-elements-section">
                                <!-- Observable Elements Title with Select Button -->
                                <div class="observable-elements-header">
                                    <h3 class="section-title">
                                        {{resourceService?.frmelmnts?.lbl?.observableElements || 'Observable Elements'}}
                                    </h3>
                                    <button type="button" 
                                            class="sb-btn sb-btn-normal sb-btn-dark-green font-weight-bold select-button"
                                            (click)="openObservableElementsModal()">
                                        <i class="plus square icon"></i>
                                        {{resourceService?.frmelmnts?.btn?.select || 'Select'}}
                                    </button>
                                </div>
                                
                                <!-- Display selected observable elements (if any) -->
                                <div *ngIf="selectedObservableElements.length > 0" 
                                     class="selected-elements-container">
                                    <div class="selected-elements-label">
                                        {{resourceService?.frmelmnts?.lbl?.selectedElements || 'Selected Elements'}} ({{selectedObservableElements.length}})
                                    </div>
                                    <div class="selected-elements-chips">
                                        <span *ngFor="let element of selectedObservableElements" 
                                              class="ui label small element-chip">
                                            {{element.name}}
                                            <i class="delete icon element-delete" 
                                               (click)="removeObservableElement(element)"></i>
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Placeholder when no elements selected -->
                                <div *ngIf="selectedObservableElements.length === 0" 
                                     class="no-elements-placeholder">
                                    {{resourceService?.frmelmnts?.lbl?.noElementsSelected || 'No observable elements selected. Click "Select" to choose elements.'}}
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading State -->
<div class="ui active centered inline loader" *ngIf="isLoading"></div>

<!-- Observable Elements Selection Modal -->
<sui-modal *ngIf="showObservableElementsModal" [mustScroll]="true" [isClosable]="false" [transitionDuration]="0" [size]="'large'"
  class="sb-modal sb-course-modal" (dismissed)="closeObservableElementsModal();" #observableElementsModal>

  <!--Header-->
  <div class="sb-modal-header">
    {{resourceService?.frmelmnts?.lbl?.selectObservableElements || 'Select Observable Elements'}}
  </div>
  <!--/Header-->

  <!--Content-->
  <div class="sb-modal-content sb-bg-color-primary-100 pt-0">
    <div class="observable-elements-content">
      <app-select-observable
        [options]="observableElementsOptions"
        [selected]="selectedMulti"
        [config]="{type: 'multi'}"
        placeholder="{{resourceService?.frmelmnts?.lbl?.searchSelectElements || 'Search and select elements...'}}"
        (selectedChange)="selectedMulti = $event">
      </app-select-observable>
    </div>
  </div>
  <!--/Content-->

  <!--Actions-->
  <div class="sb-modal-actions">
    <button type="button" 
            class="sb-btn sb-btn-normal sb-btn-primary" 
            (click)="saveSelectedObservableElements(observableElementsModal)"
            tabindex="0">
      {{resourceService?.frmelmnts?.btn?.save || 'Save'}} ({{selectedMulti.length}})
    </button>
    <button type="button" class="sb-btn sb-btn-normal sb-btn-outline-primary mr-8" (click)="observableElementsModal.deny('denied')">
      {{resourceService?.frmelmnts?.btn?.cancel || 'Cancel'}}
    </button>
  </div>
  <!--/Actions-->
</sui-modal>
